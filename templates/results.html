<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <title>Chat Insight</title>
    <style>
      :root {
        /* Light mode variables */
        --primary-color: #008080;
        --secondary-color: #cce4c7;
        --card-bg: rgba(255, 255, 255, 0.7);
        --text-primary: #333333;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --glass-highlight: rgba(255, 255, 255, 0.2);
        --glass-border: rgba(255, 255, 255, 0.3);
        --bg-gradient: linear-gradient(135deg, var(--secondary-color), #e8f5e9);
        --card-gradient: linear-gradient(
          135deg,
          rgba(224, 242, 241, 0.7),
          rgba(178, 223, 219, 0.7)
        );
        --spinner-bg: rgba(255, 255, 255, 0.8);
        --spinner-border: rgba(0, 128, 128, 0.2);
        --toast-bg: rgba(0, 0, 0, 0.8);
        --toast-color: white;
      }

      [data-theme="dark"] {
        /* Dark mode variables */
        --primary-color: #00a3a3;
        --secondary-color: #1a3b2a;
        --card-bg: rgba(30, 30, 30, 0.7);
        --text-primary: #e0e0e0;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --glass-highlight: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.1);
        --bg-gradient: linear-gradient(
          135deg,
          #121212,
          #1a1a1a,
          #121212,
          #1a1a1a
        );
        --card-gradient: linear-gradient(
          135deg,
          rgba(40, 44, 52, 0.7),
          rgba(30, 34, 42, 0.7)
        );
        --spinner-bg: rgba(18, 18, 18, 0.8);
        --spinner-border: rgba(0, 163, 163, 0.2);
        --toast-bg: rgba(30, 30, 30, 0.9);
        --toast-color: #e0e0e0;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-gradient);
        min-height: 100vh;
        color: var(--text-primary);
        font-family: "Segoe UI", Arial, sans-serif;
        padding: 2rem;
        line-height: 1.6;
        transition: background 0.3s ease, color 0.3s ease;
      }

      /* Theme toggle styles */
      .theme-switch-wrapper {
        display: flex;
        align-items: center;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
      }

      .theme-switch {
        display: inline-block;
        height: 24px;
        position: relative;
        width: 50px;
      }

      .theme-switch input {
        display: none;
      }

      .slider {
        background-color: #ccc;
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        background-color: white;
        bottom: 4px;
        content: "";
        height: 16px;
        left: 4px;
        position: absolute;
        transition: 0.4s;
        width: 16px;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--primary-color);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .slider-icons {
        display: flex;
        justify-content: space-between;
        padding: 0 6px;
        align-items: center;
        height: 100%;
        color: white;
        font-size: 12px;
      }

      /* Header Styles */
      .header {
        text-align: center;
        margin-bottom: 3rem;
        animation: fadeIn 0.8s ease-out;
      }

      .header h1 {
        font-size: 3.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px var(--shadow-color);
      }

      .description {
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 32px var(--shadow-color);
        border: 1px solid var(--glass-border);
      }

      /* Card Grid Layout */
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        max-width: 1800px;
        margin: 0 auto;
      }

      /* Card Styles */
      .card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px var(--shadow-color);
        transition: all 0.3s ease;
        cursor: grab;
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--glass-border);
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: -50%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          var(--glass-highlight),
          transparent
        );
        transform: skewX(-25deg);
        transition: 0.5s;
        opacity: 0;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px var(--shadow-color);
      }

      .card:hover::before {
        left: 150%;
        opacity: 0.5;
      }

      .card h2 {
        color: var(--primary-color);
        font-size: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--glass-border);
        position: relative;
      }

      /* Word Cloud Style */
      .word-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .word-tag {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        color: var(--text-primary);
        transition: transform 0.2s ease;
        animation: fadeIn 0.5s ease-out;
        border: 1px solid var(--glass-border);
      }

      .word-tag:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      /* Message List Styles */
      .message-list {
        padding-left: 1.2rem;
      }

      .message-list li {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border-radius: 8px;
        transition: transform 0.2s ease;
        border: 1px solid var(--glass-border);
      }

      .message-list li:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      /* Emoji Cloud Styles */
      .emoji-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .emoji-tag {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 1.2rem;
        color: var(--text-primary);
        transition: transform 0.2s ease;
        animation: fadeIn 0.5s ease-out;
        border: 1px solid var(--glass-border);
      }

      .emoji-tag:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      /* Chart Container Styles */
      .chart-container {
        width: 100%;
        height: auto;
        min-height: 250px;
        margin-top: 1rem;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
      }

      .chart-container img {
        width: 100%;
        height: auto;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .chart-container:hover img {
        transform: scale(1.02);
      }

      /* Links Style */
      .links-list {
        list-style: none;
        padding: 0;
      }

      .links-list li {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border-radius: 8px;
        transition: transform 0.2s ease;
        border: 1px solid var(--glass-border);
      }

      .links-list li:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      .links-list a {
        color: var(--primary-color);
        text-decoration: none;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .header h1 {
          font-size: 2.5rem;
        }

        .grid-container {
          grid-template-columns: 1fr;
        }

        .card {
          min-height: 150px;
        }

        .theme-switch-wrapper {
          top: 10px;
          right: 10px;
        }
      }

      /* Drag and Drop Styles */
      .card.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      /* Enhanced Visualization Styles */
      .visualization {
        margin-top: 3rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        max-width: 1800px;
        margin: 2rem auto;
      }

      .chart-wrapper {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        min-height: 350px;
        box-shadow: 0 8px 32px var(--shadow-color);
        transition: all 0.3s ease;
        border: 1px solid var(--glass-border);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .chart-wrapper::before {
        content: "";
        position: absolute;
        top: 0;
        left: -50%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          var(--glass-highlight),
          transparent
        );
        transform: skewX(-25deg);
        transition: 0.5s;
        opacity: 0;
      }

      .chart-wrapper:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px var(--shadow-color);
      }

      .chart-wrapper:hover::before {
        left: 150%;
        opacity: 0.5;
      }

      .chart-wrapper h2 {
        color: var(--primary-color);
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 0.8rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--glass-border);
      }

      .chart-wrapper img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px var(--shadow-color);
        object-fit: contain;
      }

      .chart-wrapper:hover img {
        transform: scale(1.02);
      }

      /* Spinner Styles */
      .spinner-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--spinner-bg);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--spinner-border);
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        box-shadow: 0 0 10px var(--shadow-color);
      }

      .spinner-text {
        position: absolute;
        margin-top: 100px;
        color: var(--primary-color);
        font-size: 1.2em;
        font-weight: bold;
        text-shadow: 0 2px 4px var(--shadow-color);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Share Button Styles */
      .share-buttons {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
        z-index: 10;
      }

      .share-button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .share-button:hover {
        transform: scale(1.1);
        background: #006666;
        box-shadow: 0 6px 12px var(--shadow-color);
      }

      .share-button i {
        font-size: 1.2rem;
      }

      /* Floating Action Button */
      .fab {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 0 20px;
        height: 56px;
        border-radius: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 15px var(--shadow-color);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        border: none;
        font-size: 1rem;
        font-weight: 500;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }

      .fab:hover {
        transform: scale(1.05);
        background: #006666;
        box-shadow: 0 6px 20px var(--shadow-color);
      }

      .fab i {
        font-size: 1.2rem;
      }

      /* Share Menu */
      .share-menu {
        position: fixed;
        bottom: 150px;
        right: 20px;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 8px 32px var(--shadow-color);
        display: none;
        z-index: 1000;
        border: 1px solid var(--glass-border);
      }

      .share-menu.active {
        display: block;
        animation: slideUp 0.3s ease;
      }

      .share-menu button {
        display: block;
        width: 100%;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        border: none;
        background: var(--card-gradient);
        color: var(--text-primary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid var(--glass-border);
      }

      .share-menu button:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(5px);
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--toast-bg);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        color: var(--toast-color);
        padding: 1rem 2rem;
        border-radius: 25px;
        font-size: 0.9rem;
        display: none;
        z-index: 1001;
        box-shadow: 0 4px 15px var(--shadow-color);
      }

      .toast.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* SVG Icon Styles */
      .icon {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }
    </style>
  </head>
  <body>
    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider">
          <div class="slider-icons">
            <span>☀️</span>
            <span>🌙</span>
          </div>
        </div>
      </label>
    </div>

    <div class="spinner-container" id="spinnerContainer">
      <div class="spinner"></div>
      <div class="spinner-text">Loading visualizations...</div>
    </div>

    <div class="header">
      <h1>
        <a href="/" style="text-decoration: none; color: inherit"
          >Chat Insight</a
        >
      </h1>
      <div class="description">
        <p>
          This app provides insights into chat interactions, analyzing message
          counts, active times, and participant engagement to enhance
          communication strategies.
        </p>
      </div>
    </div>

    <div class="grid-container">
      <!-- Chat Type Card -->
      <div class="card" draggable="true">
        <h2>Chat Type</h2>
        <p>{{ 'Group Chat' if results.is_group else 'Individual Chat' }}</p>
        {% if results.is_group %}
        <p>Number of Participants: {{ results.participant_count }}</p>
        {% endif %}
      </div>

      {% if results.is_group %}
      <!-- Group Activity Distribution -->
      <div class="card" draggable="true">
        <h2>Group Activity Distribution</h2>
        <p>
          Most Active Member: {{ results.group_dynamics.most_active_member }}
        </p>
        <p>
          Least Active Member: {{ results.group_dynamics.least_active_member }}
        </p>
      </div>
      {% else %}
      <!-- Conversation Balance -->
      <div class="card" draggable="true">
        <h2>Conversation Balance</h2>
        <p>Message ratio: {{ results.conversation_balance.message_ratio }}</p>
      </div>
      {% endif %}

      <!-- Message Counts Card -->
      <div class="card" draggable="true">
        <h2>Message Counts</h2>
        <ol class="message-list">
          {% for participant, count in results.top_participants.items() %}
          <li>{{ participant }}: {{ count }}</li>
          {% endfor %}
        </ol>
      </div>

      <!-- Most Active Day Card -->
      <div class="card" draggable="true">
        <h2>Most Active Day</h2>
        <p>{{ results.most_active_day.strftime('%d %B %Y') }}</p>
      </div>

      <!-- Most Active Time Card -->
      <div class="card" draggable="true">
        <h2>Most Active Time</h2>
        <p>
          {% if results.most_active_time is not none %} {{
          results.most_active_time }}:00 hours {% else %} No data available {%
          endif %}
        </p>
      </div>

      <!-- Most Common Words Card -->
      <div class="card" draggable="true">
        <h2>Most Commonly Used Words</h2>
        <div class="word-cloud">
          {% if results.most_common_words %} {% for word, freq in
          results.most_common_words %}
          <span class="word-tag">{{ word }}: {{ freq }}</span>
          {% endfor %} {% else %}
          <p>No word frequency data available</p>
          {% endif %}
        </div>
      </div>

      <!-- Top Emojis Card -->
      <div class="card" draggable="true">
        <h2>Top Emojis</h2>
        <div class="emoji-cloud">
          {% if results.emojis and results.emojis.items()|length > 0 %} {% for
          emoji, count in results.emojis.items() %}
          <span class="emoji-tag">{{ emoji }}: {{ count }}</span>
          {% endfor %} {% else %}
          <p>No emoji data available</p>
          {% endif %}
        </div>
      </div>

      <!-- Links Card -->
      <div class="card" draggable="true">
        <h2>Top Links</h2>
        <ul class="links-list">
          {% for link, count in results.links.items() %}
          <li>
            <a href="{{ link }}" target="_blank">{{ link }}</a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- First Message Card -->
      <div class="card" draggable="true">
        <h2>First Message</h2>
        <p>{{ results.first_message_date.strftime('%d %B %Y') }}</p>
      </div>

      <!-- Last Message Card -->
      <div class="card" draggable="true">
        <h2>Last Message</h2>
        <p>{{ results.last_message_date.strftime('%d %B %Y') }}</p>
      </div>

      <!-- Average Messages Per Day Card -->
      <div class="card" draggable="true">
        <h2>Average Messages Per Day</h2>
        <p>{{ results.avg_messages_per_day|round }}</p>
      </div>
    </div>

    <!-- Visualizations Section -->
    <div class="visualization">
      <!-- Word Cloud -->
      <div class="chart-wrapper">
        <h2>Frequently Used Words</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.wordcloud }}"
            alt="Word Cloud"
          />
        </div>
      </div>

      <!-- Average Messages -->
      <div class="chart-wrapper">
        <h2>Average Messages Sent per Day</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.average_messages_per_day }}"
            alt="Average Messages Sent per Day"
          />
        </div>
      </div>

      <!-- First Message Sender -->
      <div class="chart-wrapper">
        <h2>First Message Sender</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.first_message_sender }}"
            alt="First Message Sender"
          />
        </div>
      </div>

      <!-- Emoji Usage -->
      <div class="chart-wrapper">
        <h2>
          {% if chat_type == 'romantic' %}Love Emoji Usage{% else %}Friendly
          Emoji Usage{% endif %}
        </h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.love_counts if chat_type == 'romantic' else results.visualization_paths.friendship_emoji_counts }}"
            alt="{% if chat_type == 'romantic' %}Love Emoji Counts{% else %}Friendly Emoji Usage{% endif %}"
          />
        </div>
      </div>

      <!-- Sentiment Counts -->
      <div class="chart-wrapper">
        <h2>Sentiment Counts</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.sentiment_counts }}"
            alt="Sentiment Counts"
          />
        </div>
      </div>

      <!-- Links Shared -->
      <div class="chart-wrapper">
        <h2>Links Shared by Each Sender</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.links_shared_by_sender }}"
            alt="Links Shared by Each Sender"
            style="transition: transform 0.2s ease; cursor: zoom-in"
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'"
          />
        </div>
      </div>

      <!-- Top Emojis -->
      <div class="chart-wrapper">
        <h2>Top Emojis</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.top_emojis }}"
            alt="Top Emojis"
          />
        </div>
      </div>

      <!-- Messages per User -->
      <div class="chart-wrapper">
        <h2>Messages sent per user</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.messages_count_per_sender }}"
            alt="Total messages per user"
          />
        </div>
      </div>

      <!-- Message Activity Over Time -->
      <div class="chart-wrapper">
        <h2>Message Activity Over Time</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.message_activity_over_time }}"
            alt="Message Activity Over Time"
          />
        </div>
      </div>

      <!-- Message Activity Heatmap -->
      <div class="chart-wrapper">
        <h2>Message Activity Heatmap</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.message_activity_heatmap }}"
            alt="Message Activity Heatmap"
          />
        </div>
      </div>

      <!-- Message Length -->
      <div class="chart-wrapper">
        <h2>Message Length</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.message_length_distribution }}"
            alt="Message Length"
          />
        </div>
      </div>

      <!-- Response Time Distribution -->
      <div class="chart-wrapper">
        <h2>Response Time Distribution</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.response_time_distribution }}"
            alt="Response Time Distribution"
          />
        </div>
      </div>

      <!-- Daily Pattern -->
      <div class="chart-wrapper">
        <h2>Daily Message Pattern</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.daily_pattern }}"
            alt="Daily Message Pattern"
          />
        </div>
      </div>

      {% if results.is_group %}
      <!-- Group Participation -->
      <div class="chart-wrapper">
        <h2>Group Participation Distribution</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.group_participation }}"
            alt="Group Participation Distribution"
          />
        </div>
      </div>

      <!-- Group Interaction Network -->
      <div class="chart-wrapper">
        <h2>Group Interaction Network</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.group_interaction_network }}"
            alt="Group Interaction Network"
          />
        </div>
      </div>
      {% else %}
      <!-- Conversation Flow -->
      <div class="chart-wrapper">
        <h2>Conversation Flow Analysis</h2>
        <div class="chart-container">
          <img
            src="{{ results.visualization_paths.conversation_flow }}"
            alt="Conversation Flow Analysis"
          />
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Floating Action Button and Share Menu -->
    <button
      class="fab"
      onclick="toggleShareMenu()"
      aria-label="Open share menu"
    >
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"
        />
      </svg>
      <span>Share</span>
    </button>

    <div class="share-menu" id="shareMenu">
      <button onclick="shareFullAnalysis()">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"
          />
        </svg>
        Share Analysis
      </button>
      <button onclick="downloadAllVisuals()">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
        </svg>
        Download All Visuals
      </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <footer
      style="
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: var(--primary-color);
        color: white;
        text-align: center;
        padding: 10px 0;
        font-size: 0.8em;
      "
    >
      <div style="max-width: 1800px; margin: 0 auto; padding: 0 2rem">
        <p style="margin: 0; color: white">
          Made with ❤️ by Google Jr & Thabhelo |
          <a
            href="https://github.com/xeroxzen/chat-insight"
            style="color: white; text-decoration: none"
            target="_blank"
            rel="noopener"
          >
            Open Source on GitHub
          </a>
          |
          <a href="/privacy-policy" style="color: white; text-decoration: none">
            Privacy Policy
          </a>
        </p>
      </div>
    </footer>

    <script>
      // Dark mode toggle functionality
      const toggleSwitch = document.querySelector("#checkbox");
      const html = document.querySelector("html");

      // Check for saved theme preference
      const currentTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", currentTheme);

      // Update checkbox state based on saved preference
      if (currentTheme === "dark") {
        toggleSwitch.checked = true;
      }

      // Handle theme switch
      function switchTheme(e) {
        if (e.target.checked) {
          html.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
        } else {
          html.setAttribute("data-theme", "light");
          localStorage.setItem("theme", "light");
        }
      }

      toggleSwitch.addEventListener("change", switchTheme, false);

      // Drag and Drop Functionality
      const cards = document.querySelectorAll(".card");

      cards.forEach((card) => {
        card.addEventListener("dragstart", () => {
          card.classList.add("dragging");
        });

        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
        });
      });

      const gridContainer = document.querySelector(".grid-container");

      gridContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingCard = document.querySelector(".dragging");
        const cards = [
          ...gridContainer.querySelectorAll(".card:not(.dragging)"),
        ];
        const closestCard = cards.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = e.clientY - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;

        if (closestCard) {
          gridContainer.insertBefore(draggingCard, closestCard);
        } else {
          gridContainer.appendChild(draggingCard);
        }
      });

      // Image loading spinner
      const spinnerContainer = document.getElementById("spinnerContainer");
      const images = document.querySelectorAll(".chart-container img");
      let loadedImages = 0;

      function showSpinner() {
        spinnerContainer.style.display = "flex";
      }

      function hideSpinner() {
        spinnerContainer.style.display = "none";
      }

      // Show spinner when page loads
      showSpinner();

      // Track image loading
      images.forEach((img) => {
        if (img.complete) {
          loadedImages++;
        } else {
          img.addEventListener("load", () => {
            loadedImages++;
            if (loadedImages === images.length) {
              hideSpinner();
            }
          });
        }
      });

      // If all images are already loaded, hide spinner
      if (loadedImages === images.length) {
        hideSpinner();
      }

      // Sharing functionality
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("active");
        setTimeout(() => toast.classList.remove("active"), duration);
      }

      function toggleShareMenu() {
        const menu = document.getElementById("shareMenu");
        menu.classList.toggle("active");
      }

      async function shareImage(button) {
        const img = button.closest(".chart-container").querySelector("img");
        const title = button.dataset.title;

        try {
          if (navigator.share) {
            const response = await fetch(img.src);
            const blob = await response.blob();
            const file = new File([blob], `${title}.png`, {
              type: "image/png",
            });

            await navigator.share({
              title: `Chat Insight - ${title}`,
              text: "Check out this chat analysis visualization!",
              files: [file],
            });
          } else {
            // Fallback to copying link
            await copyImageLink(img.src);
          }
        } catch (error) {
          // Don't show error for user cancellation
          if (error.name !== "AbortError") {
            console.error("Error sharing:", error);
            showToast("Unable to share. Try downloading instead.");
          }
        }
      }

      async function downloadImage(button) {
        const img = button.closest(".chart-container").querySelector("img");
        const title = button.dataset.title;

        try {
          const response = await fetch(img.src);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${title}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Error downloading:", error);
          showToast("Unable to download. Please try again.");
        }
      }

      async function shareFullAnalysis() {
        try {
          if (navigator.share) {
            await navigator.share({
              title: "Chat Insight Analysis",
              text: "Check out my chat analysis!",
              url: window.location.href,
            });
          } else {
            await copyLink();
          }
        } catch (error) {
          // Don't show error for user cancellation
          if (error.name !== "AbortError") {
            console.error("Error sharing:", error);
            showToast("Unable to share. Try copying the link instead.");
          }
        }
        toggleShareMenu();
      }

      async function downloadAllVisuals() {
        const images = document.querySelectorAll(".chart-container img");
        let count = 0;

        for (const img of images) {
          try {
            const title = img
              .closest(".chart-container")
              .previousElementSibling.textContent.trim();
            const response = await fetch(img.src);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${title}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            count++;
          } catch (error) {
            console.error("Error downloading:", error);
          }
        }

        showToast(`Downloaded ${count} visualizations`);
        toggleShareMenu();
      }

      async function copyLink() {
        try {
          await navigator.clipboard.writeText(window.location.href);
          showToast("Link copied to clipboard!");
        } catch (error) {
          console.error("Error copying link:", error);
          showToast("Unable to copy link. Please try again.");
        }
        toggleShareMenu();
      }

      async function copyImageLink(imageUrl) {
        try {
          await navigator.clipboard.writeText(imageUrl);
          showToast("Image link copied to clipboard!");
        } catch (error) {
          console.error("Error copying image link:", error);
          showToast("Unable to copy image link. Please try again.");
        }
      }
    </script>
  </body>
</html>
