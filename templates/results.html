<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <title>Chat Insight</title>
    <style>
      :root {
        /* Light mode variables */
        --primary-color: #008080;
        --secondary-color: #cce4c7;
        --card-bg: rgba(255, 255, 255, 0.7);
        --text-primary: #333333;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --glass-highlight: rgba(255, 255, 255, 0.2);
        --glass-border: rgba(255, 255, 255, 0.3);
        --bg-gradient: linear-gradient(135deg, var(--secondary-color), #e8f5e9);
        --card-gradient: linear-gradient(
          135deg,
          rgba(224, 242, 241, 0.7),
          rgba(178, 223, 219, 0.7)
        );
        --spinner-bg: rgba(255, 255, 255, 0.8);
        --spinner-border: rgba(0, 128, 128, 0.2);
        --toast-bg: rgba(0, 0, 0, 0.8);
        --toast-color: white;
      }

      [data-theme="dark"] {
        /* Dark mode variables */
        --primary-color: #00a3a3;
        --secondary-color: #1a3b2a;
        --card-bg: rgba(30, 30, 30, 0.7);
        --text-primary: #e0e0e0;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --glass-highlight: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.1);
        --bg-gradient: linear-gradient(
          135deg,
          #121212,
          #1a1a1a,
          #121212,
          #1a1a1a
        );
        --card-gradient: linear-gradient(
          135deg,
          rgba(40, 44, 52, 0.7),
          rgba(30, 34, 42, 0.7)
        );
        --spinner-bg: rgba(18, 18, 18, 0.8);
        --spinner-border: rgba(0, 163, 163, 0.2);
        --toast-bg: rgba(30, 30, 30, 0.9);
        --toast-color: #e0e0e0;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-gradient);
        min-height: 100vh;
        color: var(--text-primary);
        font-family: "Segoe UI", Arial, sans-serif;
        padding: 2rem;
        line-height: 1.6;
        transition: background 0.3s ease, color 0.3s ease;
      }

      /* Theme toggle styles */
      .theme-switch-wrapper {
        display: flex;
        align-items: center;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
      }

      .theme-switch {
        display: inline-block;
        height: 24px;
        position: relative;
        width: 50px;
      }

      .theme-switch input {
        display: none;
      }

      .slider {
        background-color: #ccc;
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        background-color: white;
        bottom: 4px;
        content: "";
        height: 16px;
        left: 4px;
        position: absolute;
        transition: 0.4s;
        width: 16px;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--primary-color);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .slider-icons {
        display: flex;
        justify-content: space-between;
        padding: 0 6px;
        align-items: center;
        height: 100%;
        color: white;
        font-size: 12px;
      }

      /* Header Styles */
      .header {
        text-align: center;
        margin-bottom: 3rem;
        animation: fadeIn 0.8s ease-out;
      }

      .header h1 {
        font-size: 3.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px var(--shadow-color);
      }

      .description {
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 32px var(--shadow-color);
        border: 1px solid var(--glass-border);
      }

      /* Card Grid Layout */
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        max-width: 1800px;
        margin: 0 auto;
      }

      /* Card Styles */
      .card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px var(--shadow-color);
        transition: all 0.3s ease;
        cursor: grab;
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--glass-border);
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: -50%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          var(--glass-highlight),
          transparent
        );
        transform: skewX(-25deg);
        transition: 0.5s;
        opacity: 0;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px var(--shadow-color);
      }

      .card:hover::before {
        left: 150%;
        opacity: 0.5;
      }

      .card h2 {
        color: var(--primary-color);
        font-size: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--glass-border);
        position: relative;
      }

      /* Word Cloud Style */
      .word-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .word-tag {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        color: var(--text-primary);
        transition: transform 0.2s ease;
        animation: fadeIn 0.5s ease-out;
        border: 1px solid var(--glass-border);
      }

      .word-tag:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      /* Message List Styles */
      .message-list {
        padding-left: 1.2rem;
      }

      .message-list li {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border-radius: 8px;
        transition: transform 0.2s ease;
        border: 1px solid var(--glass-border);
      }

      .message-list li:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      /* Emoji Cloud Styles */
      .emoji-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .emoji-tag {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 1.2rem;
        color: var(--text-primary);
        transition: transform 0.2s ease;
        animation: fadeIn 0.5s ease-out;
        border: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .emoji-tag:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      .emoji-count {
        font-size: 0.9rem;
        opacity: 0.8;
        background: rgba(0, 0, 0, 0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
      }

      /* Emoji Stats Styles */
      .emoji-stats {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .sender-emoji-stats {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        transition: transform 0.2s ease;
      }

      .sender-emoji-stats:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px var(--shadow-color);
      }

      .sender-emoji-stats h3 {
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        border-bottom: 1px solid var(--glass-border);
        padding-bottom: 0.5rem;
      }

      .favorite-emojis {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .favorite-emojis .emoji-tag {
        font-size: 1.5rem;
        padding: 0.3rem 0.8rem;
      }

      /* Chart Container Styles */
      .chart-container {
        width: 100%;
        height: auto;
        min-height: 250px;
        margin-top: 1rem;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
      }

      .chart-container img {
        width: 100%;
        height: auto;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .chart-container:hover img {
        transform: scale(1.02);
      }

      /* Links Style */
      .links-list {
        list-style: none;
        padding: 0;
      }

      .links-list li {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border-radius: 8px;
        transition: transform 0.2s ease;
        border: 1px solid var(--glass-border);
      }

      .links-list li:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      .links-list a {
        color: var(--primary-color);
        text-decoration: none;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .header h1 {
          font-size: 2.5rem;
        }

        .grid-container {
          grid-template-columns: 1fr;
        }

        .card {
          min-height: 150px;
        }

        .theme-switch-wrapper {
          top: 10px;
          right: 10px;
        }
      }

      /* Drag and Drop Styles */
      .card.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      /* Enhanced Visualization Styles */
      .visualization {
        margin-top: 3rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        max-width: 1800px;
        margin: 2rem auto;
      }

      .chart-wrapper {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        min-height: 350px;
        box-shadow: 0 8px 32px var(--shadow-color);
        transition: all 0.3s ease;
        border: 1px solid var(--glass-border);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .chart-wrapper::before {
        content: "";
        position: absolute;
        top: 0;
        left: -50%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          var(--glass-highlight),
          transparent
        );
        transform: skewX(-25deg);
        transition: 0.5s;
        opacity: 0;
      }

      .chart-wrapper:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px var(--shadow-color);
      }

      .chart-wrapper:hover::before {
        left: 150%;
        opacity: 0.5;
      }

      .chart-wrapper h2 {
        color: var(--primary-color);
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 0.8rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--glass-border);
      }

      .chart-wrapper img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        transition: transform 0.3s ease;
        box-shadow: 0 5px 15px var(--shadow-color);
        object-fit: contain;
      }

      .chart-wrapper:hover img {
        transform: scale(1.02);
      }

      /* Spinner Styles */
      .spinner-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--spinner-bg);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--spinner-border);
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        box-shadow: 0 0 10px var(--shadow-color);
      }

      .spinner-text {
        position: absolute;
        margin-top: 100px;
        color: var(--primary-color);
        font-size: 1.2em;
        font-weight: bold;
        text-shadow: 0 2px 4px var(--shadow-color);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Share Button Styles */
      .share-buttons {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
        z-index: 10;
      }

      .share-button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      .share-button:hover {
        transform: scale(1.1);
        background: #006666;
        box-shadow: 0 6px 12px var(--shadow-color);
      }

      .share-button i {
        font-size: 1.2rem;
      }

      /* Floating Action Button */
      .fab {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 0 20px;
        height: 56px;
        border-radius: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 15px var(--shadow-color);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        border: none;
        font-size: 1rem;
        font-weight: 500;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }

      .fab:hover {
        transform: scale(1.05);
        background: #006666;
        box-shadow: 0 6px 20px var(--shadow-color);
      }

      .fab i {
        font-size: 1.2rem;
      }

      /* Share Menu */
      .share-menu {
        position: fixed;
        bottom: 150px;
        right: 20px;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 8px 32px var(--shadow-color);
        display: none;
        z-index: 1000;
        border: 1px solid var(--glass-border);
      }

      .share-menu.active {
        display: block;
        animation: slideUp 0.3s ease;
      }

      .share-menu button {
        display: block;
        width: 100%;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        border: none;
        background: var(--card-gradient);
        color: var(--text-primary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid var(--glass-border);
      }

      .share-menu button:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(5px);
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--toast-bg);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        color: var(--toast-color);
        padding: 1rem 2rem;
        border-radius: 25px;
        font-size: 0.9rem;
        display: none;
        z-index: 1001;
        box-shadow: 0 4px 15px var(--shadow-color);
      }

      .toast.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* SVG Icon Styles */
      .icon {
        width: 20px;
        height: 20px;
        fill: currentColor;
      }

      /* Section Header Styles */
      .section-header {
        text-align: center;
        margin: 3rem 0 2rem;
        animation: fadeIn 0.8s ease-out;
      }

      .section-header h2 {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px var(--shadow-color);
      }

      .section-header p {
        max-width: 800px;
        margin: 0 auto;
        opacity: 0.8;
      }

      /* Overall Emoji Stats Styles */
      .overall-emoji-stats {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .overall-emoji-stats p {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 0.8rem 1rem;
        border-radius: 10px;
        border: 1px solid var(--glass-border);
        transition: transform 0.2s ease;
      }

      .overall-emoji-stats p:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px var(--shadow-color);
      }

      .stat-label {
        font-weight: bold;
        color: var(--primary-color);
      }

      /* Emoji Highlight Section */
      .emoji-highlight {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin: 2rem auto;
        max-width: 1200px;
      }

      .emoji-highlight-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        animation: floatAnimation 3s ease-in-out infinite;
      }

      .emoji-highlight-item:nth-child(2) {
        animation-delay: 0.5s;
      }

      .emoji-highlight-item:nth-child(3) {
        animation-delay: 1s;
      }

      .emoji-highlight-item:nth-child(4) {
        animation-delay: 1.5s;
      }

      .emoji-highlight-item:nth-child(5) {
        animation-delay: 2s;
      }

      .emoji-bubble {
        background: var(--card-gradient);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 1rem;
        border-radius: 50%;
        font-size: 2.5rem;
        color: var(--text-primary);
        transition: transform 0.2s ease;
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px var(--shadow-color);
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .emoji-count-large {
        background: var(--primary-color);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 4px 8px var(--shadow-color);
      }

      @keyframes floatAnimation {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0);
        }
      }

      /* Info Text Styles */
      .info-text {
        font-size: 0.9rem;
        color: var(--primary-color);
        background: rgba(0, 128, 128, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
        border-left: 3px solid var(--primary-color);
      }
    </style>
  </head>
  <body>
    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider">
          <div class="slider-icons">
            <span>‚òÄÔ∏è</span>
            <span>üåô</span>
          </div>
        </div>
      </label>
    </div>

    <div class="spinner-container" id="spinnerContainer">
      <div class="spinner"></div>
      <div class="spinner-text">Loading visualizations...</div>
    </div>

    <div class="header">
      <h1>
        <a href="/" style="text-decoration: none; color: inherit"
          >Chat Insight</a
        >
      </h1>
      <div class="description">
        <p>
          This app provides insights into chat interactions, analyzing message
          counts, active times, and participant engagement to enhance
          communication strategies.
        </p>
      </div>
    </div>

    <!-- Main Analysis Section -->
    <div class="section-header">
      <h2>Chat Overview</h2>
      <p>Key metrics and insights from your conversation</p>
    </div>

    <div class="grid-container">
      <!-- Chat Type Card -->
      <div class="card" draggable="true">
        <h2>Chat Type</h2>
        <p>{{ 'Group Chat' if results.is_group else 'Individual Chat' }}</p>
        {% if results.is_group %}
        <p>Number of Participants: {{ results.participant_count }}</p>
        {% endif %}
      </div>

      {% if results.is_group %}
      <!-- Group Activity Distribution -->
      <div class="card" draggable="true">
        <h2>Group Activity Distribution</h2>
        <p>
          Most Active Member: {{ results.group_dynamics.most_active_member }}
        </p>
        <p>
          Least Active Member: {{ results.group_dynamics.least_active_member }}
        </p>
      </div>
      {% else %}
      <!-- Conversation Balance -->
      <div class="card" draggable="true">
        <h2>Conversation Balance</h2>
        <p>Message ratio: {{ results.conversation_balance.message_ratio }}</p>
      </div>
      {% endif %}

      <!-- Message Counts Card -->
      <div class="card" draggable="true">
        <h2>Message Counts</h2>
        <ol class="message-list">
          {% for participant, count in results.top_participants.items() %}
          <li>{{ participant }}: {{ count }}</li>
          {% endfor %}
        </ol>
      </div>

      <!-- Most Active Day Card -->
      <div class="card" draggable="true">
        <h2>Most Active Day</h2>
        <p>{{ results.most_active_day.strftime('%d %B %Y') }}</p>
      </div>

      <!-- Most Active Time Card -->
      <div class="card" draggable="true">
        <h2>Most Active Time</h2>
        <p>
          {% if results.most_active_time is not none %} {{
          results.most_active_time }}:00 hours {% else %} No data available {%
          endif %}
        </p>
      </div>

      <!-- Most Common Words Card -->
      <div class="card" draggable="true">
        <h2>Most Commonly Used Words</h2>
        <div class="word-cloud">
          {% if results.most_common_words %} {% for word, freq in
          results.most_common_words %}
          <span class="word-tag">{{ word }}: {{ freq }}</span>
          {% endfor %} {% else %}
          <p>No word frequency data available</p>
          {% endif %}
        </div>
      </div>

      <!-- Links Card -->
      <div class="card" draggable="true">
        <h2>Top Links</h2>
        <ul class="links-list">
          {% for link, count in results.links.items() %}
          <li>
            <a href="{{ link }}" target="_blank">{{ link }}</a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- First Message Card -->
      <div class="card" draggable="true">
        <h2>First Message</h2>
        <p>{{ results.first_message_date.strftime('%d %B %Y') }}</p>
      </div>

      <!-- Last Message Card -->
      <div class="card" draggable="true">
        <h2>Last Message</h2>
        <p>{{ results.last_message_date.strftime('%d %B %Y') }}</p>
      </div>

      <!-- Average Messages Per Day Card -->
      <div class="card" draggable="true">
        <h2>Average Messages Per Day</h2>
        <p>{{ results.avg_messages_per_day|round }}</p>
      </div>
    </div>

    <!-- Emoji Analysis Section -->
    <div class="section-header">
      <h2>Emoji Analysis</h2>
      <p>Detailed analysis of emoji usage in the conversation</p>
    </div>

    <!-- Emoji Highlight Section -->
    <div class="emoji-highlight">
      {% if results.emojis and results.emojis.items()|length > 0 %} {% for
      emoji, count in results.emojis.items() %} {% if loop.index <= 5 %}
      <div class="emoji-highlight-item">
        <div class="emoji-bubble">{{ emoji }}</div>
        <div class="emoji-count-large">{{ count }}</div>
      </div>
      {% endif %} {% endfor %} {% else %}
      <div class="emoji-highlight-item">
        <div class="emoji-bubble">üòä</div>
        <div class="emoji-count-large">No top emojis data</div>
      </div>
      {% endif %}
    </div>

    <div class="grid-container">
      <!-- Top Emojis Card -->
      <div class="card" draggable="true">
        <h2>Top Emojis</h2>
        <div class="emoji-cloud">
          {% if results.emojis and results.emojis.items()|length > 0 %} {% for
          emoji, count in results.emojis.items() %}
          <span class="emoji-tag"
            >{{ emoji }} <span class="emoji-count">{{ count }}</span></span
          >
          {% endfor %} {% else %}
          <p>No emoji data available</p>
          {% endif %}
        </div>
      </div>

      <!-- Overall Emoji Stats Card -->
      <div class="card" draggable="true">
        <h2>Overall Emoji Stats</h2>
        {% if results.emoji_usage %}
        <div class="overall-emoji-stats">
          <p>
            <span class="stat-label">Total Emojis:</span> {{
            results.emoji_usage.total_emoji_count }}
          </p>
          <p>
            <span class="stat-label">Messages with Emojis:</span> {{
            results.emoji_usage.messages_with_emojis }}
          </p>
          <p>
            <span class="stat-label">Emoji Percentage:</span> {{
            results.emoji_usage.emoji_percentage|round(1) }}% of messages
          </p>
        </div>
        {% else %}
        <p>No emoji usage data available</p>
        {% endif %}
      </div>

      <!-- Emoji Usage By Sender Card -->
      <div class="card" draggable="true">
        <h2>Emoji Usage By Sender</h2>
        {% if results.is_group %}
        <p class="info-text">Showing emoji usage for top 5 participants only</p>
        {% endif %} {% if results.emoji_stats_by_sender and
        results.emoji_stats_by_sender.items()|length > 0 %}
        <div class="emoji-stats">
          {% for sender, stats in results.emoji_stats_by_sender.items() %}
          <div class="sender-emoji-stats">
            <h3>{{ sender }}</h3>
            <p>Total emojis: {{ stats.total_emoji_count }}</p>
            <p>Avg per message: {{ stats.avg_emojis_per_message|round(2) }}</p>
            <p>
              Messages with emojis: {{ stats.messages_with_emojis }} ({{
              stats.emoji_percentage|round(1) }}%)
            </p>
            {% if stats.favorite_emojis %}
            <p>Favorite emojis:</p>
            <div class="favorite-emojis">
              {% for emoji_data in stats.favorite_emojis %}
              <span class="emoji-tag"
                >{{ emoji_data[0] }}
                <span class="emoji-count">{{ emoji_data[1] }}</span></span
              >
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p>No emoji usage data available</p>
        {% endif %}
      </div>
    </div>

    <!-- Media Analysis Section -->
    <div class="section-header">
      <h2>Media Analysis</h2>
      <p>Detailed analysis of media sharing in the conversation</p>
    </div>

    <!-- Media Highlight Section -->
    <div class="emoji-highlight">
      {% if results.media_analysis and results.media_analysis.media_by_type %}
      {% set media_types = { 'image': 'üì∑', 'video': 'üé¨', 'audio': 'üéµ',
      'voice_call': 'üìû', 'video_call': 'üìπ', 'missed_voice_call': 'üìû‚ùå',
      'missed_video_call': 'üìπ‚ùå' } %} {% for media_type, count in
      results.media_analysis.media_by_type.items() %} {% if loop.index <= 5 %}
      <div class="emoji-highlight-item">
        <div class="emoji-bubble">{{ media_types.get(media_type, 'üìÅ') }}</div>
        <div class="emoji-count-large">{{ count }}</div>
      </div>
      {% endif %} {% endfor %} {% else %}
      <div class="emoji-highlight-item">
        <div class="emoji-bubble">üìÅ</div>
        <div class="emoji-count-large">No media data</div>
      </div>
      {% endif %}
    </div>

    <div class="grid-container">
      <!-- Media Overview Card -->
      <div class="card" draggable="true">
        <h2>Media Overview</h2>
        {% if results.media_analysis %}
        <div class="overall-emoji-stats">
          <p>
            <span class="stat-label">Total Media Items:</span>
            {{ results.media_analysis.total_media_count }}
          </p>
          <p>
            <span class="stat-label">Images Shared:</span>
            {{ results.media_analysis.media_by_type.get('image', 0) }}
          </p>
          <p>
            <span class="stat-label">Videos Shared:</span>
            {{ results.media_analysis.media_by_type.get('video', 0) }}
          </p>
          <p>
            <span class="stat-label">Audio Messages:</span>
            {{ results.media_analysis.media_by_type.get('audio', 0) }}
          </p>
        </div>
        {% else %}
        <p>No media data available</p>
        {% endif %}
      </div>

      <!-- Call Statistics Card -->
      <div class="card" draggable="true">
        <h2>Call Statistics</h2>
        {% if results.media_analysis %}
        <div class="overall-emoji-stats">
          <p>
            <span class="stat-label">Voice Calls:</span>
            {{ results.media_analysis.media_by_type.get('voice_call', 0) }}
          </p>
          <p>
            <span class="stat-label">Video Calls:</span>
            {{ results.media_analysis.media_by_type.get('video_call', 0) }}
          </p>
          <p>
            <span class="stat-label">Missed Voice Calls:</span>
            {{ results.media_analysis.media_by_type.get('missed_voice_call', 0)
            }}
          </p>
          <p>
            <span class="stat-label">Missed Video Calls:</span>
            {{ results.media_analysis.media_by_type.get('missed_video_call', 0)
            }}
          </p>
        </div>
        {% else %}
        <p>No call data available</p>
        {% endif %}
      </div>

      <!-- Call Duration Card -->
      <div class="card" draggable="true">
        <h2>Call Duration</h2>
        {% if results.media_analysis and results.media_analysis.call_duration %}
        <div class="overall-emoji-stats">
          {% for call_type, duration_data in
          results.media_analysis.call_duration.items() %}
          <p>
            <span class="stat-label">{{ call_type|title }} Calls:</span>
            {{ duration_data.call_count }} calls
          </p>
          <p>
            <span class="stat-label">Total Duration:</span>
            {{ (duration_data.total_duration / 60)|round(1) }} minutes
          </p>
          <p>
            <span class="stat-label">Average Duration:</span>
            {{ (duration_data.avg_duration / 60)|round(1) }} minutes
          </p>
          <p>
            <span class="stat-label">Longest Call:</span>
            {{ (duration_data.max_duration / 60)|round(1) }} minutes
          </p>
          {% endfor %}
        </div>
        {% else %}
        <p>No call duration data available</p>
        {% endif %}
      </div>

      <!-- Media by Sender Card -->
      <div class="card" draggable="true">
        <h2>Top Media Sharers</h2>
        {% if results.media_analysis and results.media_analysis.media_by_sender
        %}
        <ol class="message-list">
          {% for sender, media_data in
          results.media_analysis.media_by_sender.items() %} {% if loop.index <=
          5 %} {% set total_media = 0 %} {% for media_type, count in
          media_data.items() %} {% set total_media = total_media + count %} {%
          endfor %}
          <li>{{ sender }}: {{ total_media }} media items</li>
          {% endif %} {% endfor %}
        </ol>
        {% else %}
        <p>No media by sender data available</p>
        {% endif %}
      </div>

      <!-- Media Sharing Patterns Card -->
      <div class="card" draggable="true">
        <h2>Media Sharing Patterns</h2>
        {% if results.media_analysis and
        results.media_analysis.media_sharing_patterns %}
        <div class="overall-emoji-stats">
          <p>
            <span class="stat-label">Total Media Count:</span>
            {{ results.media_analysis.media_sharing_patterns.total_media_count
            }}
          </p>
          {% if
          results.media_analysis.media_sharing_patterns.most_shared_media_type
          %}
          <p>
            <span class="stat-label">Most Shared Media:</span>
            {% for sender, data in
            results.media_analysis.media_sharing_patterns.most_shared_media_type.items()
            %} {% if loop.index <= 3 %}
            <br />{{ sender }}: {{ data.type }} ({{ data.count }}) {% endif %}
            {% endfor %}
          </p>
          {% endif %}
        </div>
        {% else %}
        <p>No media sharing patterns data available</p>
        {% endif %}
      </div>
    </div>

    <!-- Visualizations Section -->
    <div class="section-header">
      <h2>Visualizations</h2>
      <p>Visual representation of chat analysis</p>
    </div>

    <div class="visualization">
      <!-- Word Cloud -->
      <div class="chart-wrapper">
        <h2>Word Cloud</h2>
        <div class="chart-container">
          {% if results.visualization_paths.wordcloud %}
          <img
            src="{{ results.visualization_paths.wordcloud }}"
            alt="Word Cloud"
          />
          {% else %}
          <p>No word cloud visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Average Messages Per Day -->
      <div class="chart-wrapper">
        <h2>Average Messages Per Day</h2>
        <div class="chart-container">
          {% if results.visualization_paths.average_messages_per_day %}
          <img
            src="{{ results.visualization_paths.average_messages_per_day }}"
            alt="Average Messages Per Day"
          />
          {% else %}
          <p>No average messages per day visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- First Message Sender -->
      <div class="chart-wrapper">
        <h2>First Message Sender</h2>
        <div class="chart-container">
          {% if results.visualization_paths.first_message_sender %}
          <img
            src="{{ results.visualization_paths.first_message_sender }}"
            alt="First Message Sender"
          />
          {% else %}
          <p>No first message sender visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Emoji Usage by Sender -->
      <div class="chart-wrapper">
        <h2>Emoji Usage by Sender</h2>
        <div class="chart-container">
          {% if results.visualization_paths.emoji_usage_by_sender %}
          <img
            src="{{ results.visualization_paths.emoji_usage_by_sender }}"
            alt="Emoji Usage by Sender"
          />
          {% else %}
          <p>No emoji usage visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Sentiment Analysis -->
      <div class="chart-wrapper">
        <h2>Sentiment Analysis</h2>
        <div class="chart-container">
          {% if results.visualization_paths.sentiment_counts %}
          <img
            src="{{ results.visualization_paths.sentiment_counts }}"
            alt="Sentiment Analysis"
          />
          {% else %}
          <p>No sentiment analysis visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Links Shared by Sender -->
      <div class="chart-wrapper">
        <h2>Links Shared by Sender</h2>
        <div class="chart-container">
          {% if results.visualization_paths.links_shared_by_sender %}
          <img
            src="{{ results.visualization_paths.links_shared_by_sender }}"
            alt="Links Shared by Sender"
          />
          {% else %}
          <p>No links shared visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Top Emojis -->
      <div class="chart-wrapper">
        <h2>Top Emojis</h2>
        <div class="chart-container">
          {% if results.visualization_paths.top_emojis %}
          <img
            src="{{ results.visualization_paths.top_emojis }}"
            alt="Top Emojis"
          />
          {% else %}
          <p>No top emojis visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Messages Count Per Sender -->
      <div class="chart-wrapper">
        <h2>Messages sent per user</h2>
        <div class="chart-container">
          {% if results.visualization_paths.messages_count_per_sender %}
          <img
            src="{{ results.visualization_paths.messages_count_per_sender }}"
            alt="Messages Count Per Sender"
          />
          {% else %}
          <p>No messages count per sender visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Message Activity Over Time -->
      <div class="chart-wrapper">
        <h2>Message Activity Over Time</h2>
        <div class="chart-container">
          {% if results.visualization_paths.message_activity_over_time %}
          <img
            src="{{ results.visualization_paths.message_activity_over_time }}"
            alt="Message Activity Over Time"
          />
          {% else %}
          <p>No message activity over time visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Message Activity Heatmap -->
      <div class="chart-wrapper">
        <h2>Message Activity Heatmap</h2>
        <div class="chart-container">
          {% if results.visualization_paths.message_activity_heatmap %}
          <img
            src="{{ results.visualization_paths.message_activity_heatmap }}"
            alt="Message Activity Heatmap"
          />
          {% else %}
          <p>No message activity heatmap visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Message Length Distribution -->
      <div class="chart-wrapper">
        <h2>Message Length</h2>
        <div class="chart-container">
          {% if results.visualization_paths.message_length_distribution %}
          <img
            src="{{ results.visualization_paths.message_length_distribution }}"
            alt="Message Length"
          />
          {% else %}
          <p>No message length distribution visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Response Time Distribution -->
      <div class="chart-wrapper">
        <h2>Response Time Distribution</h2>
        <div class="chart-container">
          {% if results.visualization_paths.response_time_distribution %}
          <img
            src="{{ results.visualization_paths.response_time_distribution }}"
            alt="Response Time Distribution"
          />
          {% else %}
          <p>No response time distribution visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Daily Pattern -->
      <div class="chart-wrapper">
        <h2>Daily Message Pattern</h2>
        <div class="chart-container">
          {% if results.visualization_paths.daily_pattern %}
          <img
            src="{{ results.visualization_paths.daily_pattern }}"
            alt="Daily Message Pattern"
          />
          {% else %}
          <p>No daily message pattern visualization available</p>
          {% endif %}
        </div>
      </div>

      {% if results.is_group %}
      <!-- Group Participation -->
      <div class="chart-wrapper">
        <h2>Group Participation Distribution</h2>
        <div class="chart-container">
          {% if results.visualization_paths.group_participation %}
          <img
            src="{{ results.visualization_paths.group_participation }}"
            alt="Group Participation Distribution"
          />
          {% else %}
          <p>No group participation visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Group Interaction Network -->
      <div class="chart-wrapper">
        <h2>Group Interaction Network</h2>
        <div class="chart-container">
          {% if results.visualization_paths.group_interaction_network %}
          <img
            src="{{ results.visualization_paths.group_interaction_network }}"
            alt="Group Interaction Network"
          />
          {% else %}
          <p>No group interaction network visualization available</p>
          {% endif %}
        </div>
      </div>
      {% else %}
      <!-- Conversation Flow -->
      <div class="chart-wrapper">
        <h2>Conversation Flow Analysis</h2>
        <div class="chart-container">
          {% if results.visualization_paths.conversation_flow %}
          <img
            src="{{ results.visualization_paths.conversation_flow }}"
            alt="Conversation Flow Analysis"
          />
          {% else %}
          <p>No conversation flow visualization available</p>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Media Visualizations Section -->
      <div class="section-header">
        <h2>Media Analysis</h2>
        <p>Visual representation of media sharing patterns</p>
      </div>

      <!-- Media Dashboard -->
      <div class="chart-wrapper">
        <h2>Media Dashboard</h2>
        <div class="chart-container">
          {% if results.visualization_paths.media_dashboard %}
          <img
            src="{{ results.visualization_paths.media_dashboard }}"
            alt="Media Dashboard"
          />
          {% else %}
          <p>No media dashboard visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Media Types Distribution -->
      <div class="chart-wrapper">
        <h2>Media Types Distribution</h2>
        <div class="chart-container">
          {% if results.visualization_paths.media_types_distribution %}
          <img
            src="{{ results.visualization_paths.media_types_distribution }}"
            alt="Media Types Distribution"
          />
          {% else %}
          <p>No media types distribution visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Media Sharing by Sender -->
      <div class="chart-wrapper">
        <h2>Media Sharing by Sender</h2>
        <div class="chart-container">
          {% if results.visualization_paths.media_by_sender %}
          <img
            src="{{ results.visualization_paths.media_by_sender }}"
            alt="Media Sharing by Sender"
          />
          {% else %}
          <p>No media sharing by sender visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Media Sharing Over Time -->
      <div class="chart-wrapper">
        <h2>Media Sharing Over Time</h2>
        <div class="chart-container">
          {% if results.visualization_paths.media_over_time %}
          <img
            src="{{ results.visualization_paths.media_over_time }}"
            alt="Media Sharing Over Time"
          />
          {% else %}
          <p>No media sharing over time visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Call Patterns Analysis -->
      <div class="chart-wrapper">
        <h2>Call Patterns Analysis</h2>
        <div class="chart-container">
          {% if results.visualization_paths.call_patterns %}
          <img
            src="{{ results.visualization_paths.call_patterns }}"
            alt="Call Patterns Analysis"
          />
          {% else %}
          <p>No call patterns visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Call Duration by Type -->
      <div class="chart-wrapper">
        <h2>Call Duration by Type</h2>
        <div class="chart-container">
          {% if results.visualization_paths.call_duration_by_type %}
          <img
            src="{{ results.visualization_paths.call_duration_by_type }}"
            alt="Call Duration by Type"
          />
          {% else %}
          <p>No call duration visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Average Call Duration by Type -->
      <div class="chart-wrapper">
        <h2>Average Call Duration by Type</h2>
        <div class="chart-container">
          {% if results.visualization_paths.avg_call_duration_by_type %}
          <img
            src="{{ results.visualization_paths.avg_call_duration_by_type }}"
            alt="Average Call Duration by Type"
          />
          {% else %}
          <p>No average call duration visualization available</p>
          {% endif %}
        </div>
      </div>

      <!-- Media Sharing Patterns -->
      <div class="chart-wrapper">
        <h2>Media Sharing Patterns</h2>
        <div class="chart-container">
          {% if results.visualization_paths.media_sharing_patterns %}
          <img
            src="{{ results.visualization_paths.media_sharing_patterns }}"
            alt="Media Sharing Patterns"
          />
          {% else %}
          <p>No media sharing patterns visualization available</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Floating Action Button and Share Menu -->
    <button
      class="fab"
      onclick="toggleShareMenu()"
      aria-label="Open share menu"
    >
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"
        />
      </svg>
      <span>Share</span>
    </button>

    <div class="share-menu" id="shareMenu">
      <button onclick="shareFullAnalysis()">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"
          />
        </svg>
        Share Analysis
      </button>
      <button onclick="downloadAllVisuals()">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
        </svg>
        Download All Visuals
      </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <footer
      style="
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: var(--primary-color);
        color: white;
        text-align: center;
        padding: 10px 0;
        font-size: 0.8em;
      "
    >
      <div style="max-width: 1800px; margin: 0 auto; padding: 0 2rem">
        <p style="margin: 0; color: white">
          Made with ‚ù§Ô∏è by Google Jr & Thabhelo |
          <a
            href="https://github.com/xeroxzen/chat-insight"
            style="color: white; text-decoration: none"
            target="_blank"
            rel="noopener"
          >
            Open Source on GitHub
          </a>
          |
          <a href="/privacy-policy" style="color: white; text-decoration: none">
            Privacy Policy
          </a>
        </p>
      </div>
    </footer>

    <script>
      // Dark mode toggle functionality
      const toggleSwitch = document.querySelector("#checkbox");
      const html = document.querySelector("html");

      // Check for saved theme preference
      const currentTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", currentTheme);

      // Update checkbox state based on saved preference
      if (currentTheme === "dark") {
        toggleSwitch.checked = true;
      }

      // Handle theme switch
      function switchTheme(e) {
        if (e.target.checked) {
          html.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
        } else {
          html.setAttribute("data-theme", "light");
          localStorage.setItem("theme", "light");
        }
      }

      toggleSwitch.addEventListener("change", switchTheme, false);

      // Drag and Drop Functionality
      const cards = document.querySelectorAll(".card");

      cards.forEach((card) => {
        card.addEventListener("dragstart", () => {
          card.classList.add("dragging");
        });

        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
        });
      });

      const gridContainer = document.querySelector(".grid-container");

      gridContainer.addEventListener("dragover", (e) => {
        e.preventDefault();
        const draggingCard = document.querySelector(".dragging");
        const cards = [
          ...gridContainer.querySelectorAll(".card:not(.dragging)"),
        ];
        const closestCard = cards.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = e.clientY - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;

        if (closestCard) {
          gridContainer.insertBefore(draggingCard, closestCard);
        } else {
          gridContainer.appendChild(draggingCard);
        }
      });

      // Image loading spinner
      const spinnerContainer = document.getElementById("spinnerContainer");
      const images = document.querySelectorAll(".chart-container img");
      let loadedImages = 0;

      function showSpinner() {
        spinnerContainer.style.display = "flex";
      }

      function hideSpinner() {
        spinnerContainer.style.display = "none";
      }

      // Show spinner when page loads
      showSpinner();

      // Track image loading
      images.forEach((img) => {
        if (img.complete) {
          loadedImages++;
        } else {
          img.addEventListener("load", () => {
            loadedImages++;
            if (loadedImages === images.length) {
              hideSpinner();
            }
          });
        }
      });

      // If all images are already loaded, hide spinner
      if (loadedImages === images.length) {
        hideSpinner();
      }

      // Sharing functionality
      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("active");
        setTimeout(() => toast.classList.remove("active"), duration);
      }

      function toggleShareMenu() {
        const menu = document.getElementById("shareMenu");
        menu.classList.toggle("active");
      }

      async function shareImage(button) {
        const img = button.closest(".chart-container").querySelector("img");
        const title = button.dataset.title;

        try {
          if (navigator.share) {
            const response = await fetch(img.src);
            const blob = await response.blob();
            const file = new File([blob], `${title}.png`, {
              type: "image/png",
            });

            await navigator.share({
              title: `Chat Insight - ${title}`,
              text: "Check out this chat analysis visualization!",
              files: [file],
            });
          } else {
            // Fallback to copying link
            await copyImageLink(img.src);
          }
        } catch (error) {
          // Don't show error for user cancellation
          if (error.name !== "AbortError") {
            console.error("Error sharing:", error);
            showToast("Unable to share. Try downloading instead.");
          }
        }
      }

      async function downloadImage(button) {
        const img = button.closest(".chart-container").querySelector("img");
        const title = button.dataset.title;

        try {
          const response = await fetch(img.src);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${title}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Error downloading:", error);
          showToast("Unable to download. Please try again.");
        }
      }

      async function shareFullAnalysis() {
        try {
          if (navigator.share) {
            await navigator.share({
              title: "Chat Insight Analysis",
              text: "Check out my chat analysis!",
              url: window.location.href,
            });
          } else {
            await copyLink();
          }
        } catch (error) {
          // Don't show error for user cancellation
          if (error.name !== "AbortError") {
            console.error("Error sharing:", error);
            showToast("Unable to share. Try copying the link instead.");
          }
        }
        toggleShareMenu();
      }

      async function downloadAllVisuals() {
        try {
          const response = await fetch("/download_results");
          if (!response.ok) {
            throw new Error("Failed to download visualizations.");
          }
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          showToast("Downloaded visualizations as a single ZIP file");
        } catch (error) {
          console.error("Error downloading ZIP:", error);
          showToast("Unable to download visuals. Please try again.");
        }
        toggleShareMenu();
      }

      async function copyLink() {
        try {
          await navigator.clipboard.writeText(window.location.href);
          showToast("Link copied to clipboard!");
        } catch (error) {
          console.error("Error copying link:", error);
          showToast("Unable to copy link. Please try again.");
        }
        toggleShareMenu();
      }

      async function copyImageLink(imageUrl) {
        try {
          await navigator.clipboard.writeText(imageUrl);
          showToast("Image link copied to clipboard!");
        } catch (error) {
          console.error("Error copying image link:", error);
          showToast("Unable to copy image link. Please try again.");
        }
      }
    </script>
  </body>
</html>
